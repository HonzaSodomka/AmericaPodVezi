<?php\n/**\n * Menu scraper pro menicka.cz\n * Stáhne denní menu pro celý týden a uloží do daily_menu.json\n * \n * Použití: php scrape_menu.php\n */\n\ndefine('MENU_URL', 'https://www.menicka.cz/7509-america-pod-vezi.html');\ndefine('OUTPUT_FILE', __DIR__ . '/daily_menu.json');\n\n// ZABEZPEČENÍ: Blokovat spuštění přes web prohlížeč\n// Povolujeme pouze CLI nebo pokud je skript inkludován z adminu (konstanta definována)\nif (php_sapi_name() !== 'cli' && !defined('ALLOW_SCRAPER_RUN')) {\n    http_response_code(403);\n    die('Přístup odepřen.');\n}\n\nfunction fetchWithCurl($url) {\n    if (!function_exists('curl_init')) {\n        $context = stream_context_create([\n            'http' => [\n                'method' => 'GET',\n                'header' => 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n                'timeout' => 10\n            ],\n            'ssl' => [\n                'verify_peer' => true, // SECURITY FIX\n                'verify_peer_name' => true // SECURITY FIX\n            ]\n        ]);\n        return @file_get_contents($url, false, $context);\n    }\n    \n    $ch = curl_init();\n    curl_setopt_array($ch, [\n        CURLOPT_URL => $url,\n        CURLOPT_RETURNTRANSFER => true,\n        CURLOPT_FOLLOWLOCATION => true,\n        CURLOPT_SSL_VERIFYPEER => true, // SECURITY FIX\n        CURLOPT_SSL_VERIFYHOST => 2, // SECURITY FIX (2 = verify full name)\n        CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n        CURLOPT_TIMEOUT => 10\n    ]);\n    \n    $result = curl_exec($ch);\n    $error = curl_error($ch);\n    curl_close($ch);\n    \n    if ($result === false) {\n        error_log('cURL error: ' . $error);\n        return false;\n    }\n    \n    return $result;\n}\n\nfunction scrapeMenu() {\n    $html = fetchWithCurl(MENU_URL);\n    \n    if ($html === false) {\n        error_log('Failed to fetch menu from ' . MENU_URL);\n        return false;\n    }\n    \n    $dom = new DOMDocument();\n    @$dom->loadHTML($html);\n    $xpath = new DOMXPath($dom);\n    \n    $menuData = [\n        'scraped_at' => date('Y-m-d H:i:s'),\n        'days' => []\n    ];\n    \n    $menuDivs = $xpath->query(\"//div[@class='menicka']\");\n    \n    foreach ($menuDivs as $menuDiv) {\n        $dateNodes = $xpath->query(\".//div[@class='nadpis']\", $menuDiv);\n        if ($dateNodes->length === 0) continue;\n        \n        $dayText = trim($dateNodes->item(0)->textContent);\n        \n        $dayData = [\n            'date' => $dayText,\n            'soup' => null,\n            'meals' => [],\n            'is_closed' => false,\n            'is_empty' => false\n        ];\n        \n        $fullDayText = trim($menuDiv->textContent);\n        if (stripos($fullDayText, 'zavřeno') !== false) {\n            $dayData['is_closed'] = true;\n            $menuData['days'][] = $dayData;\n            continue;\n        }\n        \n        if (stripos($fullDayText, 'nebylo zadáno') !== false) {\n            $dayData['is_empty'] = true;\n            $menuData['days'][] = $dayData;\n            continue;\n        }\n        \n        $menuItems = $xpath->query(\".//li[@class='polevka'] | .//li[@class='jidlo']\", $menuDiv);\n        \n        foreach ($menuItems as $item) {\n            $polozkaNodes = $xpath->query(\".//div[@class='polozka']\", $item);\n            $cenaNodes = $xpath->query(\".//div[@class='cena']\", $item);\n            \n            if ($polozkaNodes->length === 0 || $cenaNodes->length === 0) continue;\n            \n            $name = trim($polozkaNodes->item(0)->textContent);\n            $priceText = trim($cenaNodes->item(0)->textContent);\n            \n            if (preg_match('/(\\d+)\\s*Kč/u', $priceText, $matches)) {\n                $price = intval($matches[1]);\n            } else {\n                continue;\n            }\n            \n            if ($item->getAttribute('class') === 'polevka') {\n                $dayData['soup'] = [\n                    'name' => $name,\n                    'price' => $price\n                ];\n            } else {\n                $mealNumber = null;\n                if (preg_match('/^(\\d+)\\.\\s*(.+)$/u', $name, $mealMatches)) {\n                    $mealNumber = intval($mealMatches[1]);\n                    $name = trim($mealMatches[2]);\n                }\n                \n                $dayData['meals'][] = [\n                    'number' => $mealNumber,\n                    'name' => $name,\n                    'price' => $price\n                ];\n            }\n        }\n        \n        $menuData['days'][] = $dayData;\n    }\n    \n    return $menuData;\n}\n\nfunction saveMenu($data) {\n    $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);\n    if ($json === false) {\n        error_log('Failed to encode menu data to JSON');\n        return false;\n    }\n    \n    if (file_put_contents(OUTPUT_FILE, $json) === false) {\n        error_log('Failed to write menu to ' . OUTPUT_FILE);\n        return false;\n    }\n    \n    return true;\n}\n\n// Vlastní logika skriptu\necho \"Scraping menu from menicka.cz...\\n\";\n\n$menuData = scrapeMenu();\n\nif ($menuData === false) {\n    echo \"ERROR: Failed to scrape menu\\n\";\n    // Zpřístupníme chybový status pro admin.php\n    $scrape_success = false;\n    if (php_sapi_name() === 'cli') exit(1);\n} else {\n    if (empty($menuData['days'])) {\n        echo \"WARNING: No menu data found\\n\";\n    } else {\n        echo \"Found menu for \" . count($menuData['days']) . \" day(s)\\n\";\n    }\n    \n    if (saveMenu($menuData)) {\n        echo \"Menu saved to daily_menu.json\\n\";\n        echo \"Scraped at: \" . $menuData['scraped_at'] . \"\\n\";\n        $scrape_success = true;\n        \n        // V CLI vypíšeme menu, v adminu ne (není potřeba spamovat buffer)\n        if (php_sapi_name() === 'cli') {\n            foreach ($menuData['days'] as $day) {\n                echo \"\\n\" . $day['date'] . \":\";\n                \n                if ($day['is_closed']) {\n                    echo \" ZAVŘENO\\n\";\n                    continue;\n                }\n                \n                if ($day['is_empty']) {\n                    echo \" Nebylo zadáno menu\\n\";\n                    continue;\n                }\n                \n                echo \"\\n\";\n                \n                if ($day['soup']) {\n                    echo \"  Polévka: \" . $day['soup']['name'] . \" (\" . $day['soup']['price'] . \" Kč)\\n\";\n                }\n                foreach ($day['meals'] as $meal) {\n                    echo \"  \" . ($meal['number'] ? $meal['number'] . \". \" : \"\") . $meal['name'] . \" (\" . $meal['price'] . \" Kč)\\n\";\n                }\n            }\n        }\n    } else {\n        echo \"ERROR: Failed to save menu\\n\";\n        $scrape_success = false;\n        if (php_sapi_name() === 'cli') exit(1);\n    }\n}\n