<!DOCTYPE html>
<html lang="cs" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portál | America Pod Věží</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (build) -->
    <link rel="stylesheet" href="output.css">
    <!-- Tailwind CDN jako fallback pro admin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                gold: '#D4A373',
                black: '#0a0a0a'
              }
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              heading: ['Oswald', 'sans-serif']
            }
          }
        }
      }
    </script>
    <link rel="stylesheet" href="fa/css/fontawesome.min.css">
    <link rel="stylesheet" href="fa/css/solid.min.css">
</head>
<body class="bg-[#0a0a0a] text-white min-h-screen flex flex-col font-sans">
    
    <!-- Header -->
    <header class="bg-black border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-white font-heading font-bold tracking-[0.2em] text-lg border border-brand-gold/50 px-3 py-1 bg-brand-gold/10 shadow-[0_0_10px_rgba(212,163,115,0.2)]">
                    ADMIN
                </span>
                <span class="hidden md:inline text-brand-gold font-heading tracking-widest text-sm uppercase opacity-80">
                    America Pod Věží
                </span>
            </div>
            <div class="flex items-center gap-4">
                <a href="/" target="_blank" class="text-xs text-gray-400 hover:text-white uppercase tracking-widest transition flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i> Web
                </a>
                <button id="save-btn-top" class="bg-brand-gold text-black font-heading font-bold uppercase tracking-widest text-xs px-4 py-2 rounded-sm hover:bg-white transition">
                    Uložit
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-6 py-10">
        
        <div id="alert" class="hidden mb-8 p-4 rounded-sm text-sm font-bold border flex items-center gap-3">
            <i class="fas" id="alert-icon"></i>
            <span id="alert-text"></span>
        </div>

        <form id="admin-form" class="space-y-10">
            
            <!-- Sekce: Denní Menu -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Denní Menu</h2>
                </div>

                <p class="text-gray-400 text-sm mb-6 font-light leading-relaxed">
                    Zde můžete přidávat položky denního menu. Vyberte datum a přidejte konkrétní jídla. Stará menu se na webu automaticky přestanou zobrazovat (web zobrazuje vždy to nejbližší dostupné nebo dnešní).
                </p>

                <!-- Formulář pro přidání jídla do denního menu -->
                <div class="bg-black border border-brand-gold/30 rounded-sm p-5 shadow-[0_0_15px_rgba(212,163,115,0.1)] mb-8">
                    <h3 class="font-heading uppercase tracking-widest text-xs text-brand-gold mb-4">Přidat položku do menu:</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-heading tracking-widest uppercase text-gray-400 mb-1">Datum</label>
                            <input type="date" id="menu-date" class="w-full bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition [color-scheme:dark]">
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <div class="w-2/3">
                                <label class="block text-[10px] font-heading tracking-widest uppercase text-gray-400 mb-1">Množství</label>
                                <input type="number" id="menu-amount" placeholder="např. 150" class="w-full bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold transition">
                            </div>
                            <div class="w-1/3">
                                <label class="block text-[10px] font-heading tracking-widest uppercase text-gray-400 mb-1">Jednotka</label>
                                <select id="menu-unit" class="w-full bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-1 focus:outline-none focus:border-brand-gold transition appearance-none">
                                    <option value="g">g</option>
                                    <option value="ks">ks</option>
                                    <option value="ml">ml</option>
                                </select>
                            </div>
                        </div>
                        <div class="md:col-span-5">
                            <label class="block text-[10px] font-heading tracking-widest uppercase text-gray-400 mb-1">Název jídla / Popis</label>
                            <input type="text" id="menu-desc" placeholder="např. Hovězí burger s hranolky" class="w-full bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold transition">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-heading tracking-widest uppercase text-gray-400 mb-1">Cena (Kč)</label>
                            <input type="number" id="menu-price" placeholder="189" class="w-full bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold transition">
                        </div>
                        <div class="md:col-span-1">
                            <button type="button" id="add-menu-item-btn" class="w-full bg-white/10 hover:bg-brand-gold text-white hover:text-black border border-white/20 hover:border-brand-gold py-2 rounded-sm transition duration-300 text-sm font-bold tracking-wider uppercase">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Výpis existujících menu položek (seskupeno podle data) -->
                <div id="daily-menu-container" class="space-y-6">
                    <!-- Zde se vykreslí menu položky z JS -->
                </div>

            </section>

            <!-- Sekce: Flexibilní Otevírací doba -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Otevírací doba</h2>
                </div>

                <p class="text-gray-400 text-sm mb-6 font-light leading-relaxed">
                    Zde můžete libovolně slučovat dny, které mají stejnou otevírací dobu. 
                    Kliknutím na dny je vyberete do jedné skupiny. Jakmile skupinu vytvoříte, můžete k ní napsat čas.
                    <strong class="text-brand-gold block mt-2">Nevyplněné dny se na webu automaticky zobrazí jako ZAVŘENO.</strong>
                </p>

                <!-- Builder Container -->
                <div class="space-y-6">
                    
                    <!-- Existující skupiny -->
                    <div id="hours-groups-container" class="space-y-4">
                        <!-- Zde se vykreslí aktuální skupiny z JS -->
                    </div>

                    <!-- Přidání nové skupiny -->
                    <div id="new-group-builder" class="bg-black border border-brand-gold/30 rounded-sm p-5 shadow-[0_0_15px_rgba(212,163,115,0.1)]">
                        <h3 class="font-heading uppercase tracking-widest text-xs text-brand-gold mb-4">Vytvořit novou skupinu dnů:</h3>
                        
                        <div class="flex flex-wrap gap-2 mb-4" id="available-days">
                            <!-- Tlačítka pro volné dny vygeneruje JS -->
                        </div>

                        <div class="flex gap-3 items-center opacity-50 pointer-events-none transition-opacity duration-300" id="new-group-time-section">
                            <input type="text" id="new-group-time" placeholder="např. 11:00 - 22:00 nebo ZAVŘENO" class="flex-grow bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 placeholder-gray-600">
                            <button type="button" id="add-group-btn" class="bg-white/10 hover:bg-brand-gold text-white hover:text-black border border-white/20 hover:border-brand-gold px-4 py-2 rounded-sm transition duration-300 text-sm font-bold tracking-wider uppercase whitespace-nowrap">
                                <i class="fas fa-plus mr-1"></i> Přidat
                            </button>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Sekce: Kontakty -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Kontaktní údaje</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Hlavní telefon</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-phone text-gray-500 text-sm"></i>
                            </div>
                            <input type="text" id="phoneMain" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Alternativní telefon</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-mobile-alt text-gray-500 text-sm pl-0.5"></i>
                            </div>
                            <input type="text" id="phoneAlt" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">E-mailová adresa</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-gray-500 text-sm"></i>
                            </div>
                            <input type="email" id="email" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sekce: Rozvoz -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-motorcycle"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Rozvozové služby</h2>
                </div>
                
                <p class="text-gray-400 text-sm mb-6 font-light leading-relaxed">
                    Pokud pole pro odkaz necháte prázdné, tlačítko dané rozvozové služby se na webu <strong>nebude zobrazovat</strong>.
                    Pokud smažete oba odkazy, zmizí celá sekce "Rozvoz domů".
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Wolt -->
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Wolt (Odkaz)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-bicycle text-gray-500 text-sm"></i>
                            </div>
                            <input type="text" id="woltUrl" placeholder="https://wolt.com/..." class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                    
                    <!-- Foodora -->
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Foodora (Odkaz)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-shopping-bag text-gray-500 text-sm"></i>
                            </div>
                            <input type="text" id="foodoraUrl" placeholder="https://foodora.cz/..." class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sekce: Akce / Popup -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Vyskakovací okno (Akce)</h2>
                </div>
                
                <p class="text-gray-400 text-sm mb-6 font-light leading-relaxed">
                    Nahrajte leták (např. Vánoční otevírací doba, Denní menu apod.) a nastavte, odkdy dokdy má na webu vyskakovat. Zobrazí se návštěvníkovi vždy jen <strong>jednou za návštěvu</strong>, aby neotravovalo při procházení webu.
                </p>

                <div class="space-y-8">
                    <!-- Aktivní přepínač -->
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="promoActive" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-gold"></div>
                        <span class="ml-3 text-sm font-heading tracking-widest uppercase text-white">Zobrazit leták na webu</span>
                    </label>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Data -->
                        <div>
                            <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Zobrazovat OD</label>
                            <div class="relative">
                                <input type="date" id="promoDateFrom" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition [color-scheme:dark]">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Zobrazovat DO (včetně)</label>
                            <div class="relative">
                                <input type="date" id="promoDateTo" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition [color-scheme:dark]">
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Obrázek (Leták)</label>
                        <input type="file" id="promoImageInput" accept="image/png, image/jpeg, image/webp" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-sm file:font-bold file:bg-brand-gold file:text-black hover:file:bg-white transition cursor-pointer bg-[#1a1a1a] border border-white/20 rounded-sm">
                        <p class="text-xs text-gray-500 mt-2">Doporučený formát: na výšku nebo čtverec. Velké obrázky budou automaticky zmenšeny pro rychlé načítání.</p>
                        
                        <div class="mt-4 relative hidden w-48 border border-white/20 rounded-sm overflow-hidden" id="promoPreviewContainer">
                            <img id="promoPreview" src="" alt="Náhled akce" class="w-full h-auto">
                            <button type="button" id="promoRemoveImg" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center hover:bg-red-600 transition shadow-lg">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ulozit Dole -->
            <div class="flex justify-end pt-4">
                <button type="submit" class="bg-brand-gold text-black font-heading font-bold uppercase tracking-widest py-3 px-10 rounded-sm hover:bg-white transition shadow-[0_0_15px_rgba(212,163,115,0.4)] hover:shadow-[0_0_20px_rgba(255,255,255,0.5)] transform hover:-translate-y-1">
                    Uložit změny
                </button>
            </div>
        </form>
    </main>

    <!-- Patička -->
    <footer class="bg-black text-center py-6 border-t border-white/10 mt-auto">
        <p class="text-[10px] uppercase tracking-widest text-gray-600">
            America Pod Věží &copy; <span id="year"></span> | Admin Modul
        </p>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('admin-form');
            const alertBox = document.getElementById('alert');
            const alertIcon = document.getElementById('alert-icon');
            const alertText = document.getElementById('alert-text');
            const topSaveBtn = document.getElementById('save-btn-top');

            // Builder elements (Oteviraci doba)
            const groupsContainer = document.getElementById('hours-groups-container');
            const availableDaysContainer = document.getElementById('available-days');
            const newGroupTimeSection = document.getElementById('new-group-time-section');
            const newGroupTimeInput = document.getElementById('new-group-time');
            const addGroupBtn = document.getElementById('add-group-btn');
            
            // Promo Popup Elements
            const promoActive = document.getElementById('promoActive');
            const promoDateFrom = document.getElementById('promoDateFrom');
            const promoDateTo = document.getElementById('promoDateTo');
            const promoImageInput = document.getElementById('promoImageInput');
            const promoPreviewContainer = document.getElementById('promoPreviewContainer');
            const promoPreview = document.getElementById('promoPreview');
            const promoRemoveImg = document.getElementById('promoRemoveImg');

            // Daily Menu Elements
            const menuDateInput = document.getElementById('menu-date');
            const menuAmountInput = document.getElementById('menu-amount');
            const menuUnitInput = document.getElementById('menu-unit');
            const menuDescInput = document.getElementById('menu-desc');
            const menuPriceInput = document.getElementById('menu-price');
            const addMenuItemBtn = document.getElementById('add-menu-item-btn');
            const dailyMenuContainer = document.getElementById('daily-menu-container');

            // Set today as default date for daily menu
            menuDateInput.valueAsDate = new Date();

            const ALL_DAYS = [
                { id: 'mo', name: 'Pondělí' },
                { id: 'tu', name: 'Úterý' },
                { id: 'we', name: 'Středa' },
                { id: 'th', name: 'Čtvrtek' },
                { id: 'fr', name: 'Pátek' },
                { id: 'sa', name: 'Sobota' },
                { id: 'su', name: 'Neděle' }
            ];

            let appData = {
                flexibleHours: [],
                contacts: {},
                delivery: {},
                promoPopup: { active: false, dateFrom: '', dateTo: '', imageData: '' },
                dailyMenu: [] // Format: { id: number, date: 'YYYY-MM-DD', amount: '150', unit: 'g', desc: 'Burger', price: '189' }
            };

            let selectedDaysForNewGroup = new Set();

            const showAlert = (msg, isSuccess) => {
                alertText.textContent = msg;
                alertIcon.className = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
                alertBox.className = `mb-8 p-4 rounded-sm text-sm font-bold border flex items-center gap-3 ${isSuccess ? 'bg-green-900/20 border-green-500/50 text-green-400' : 'bg-red-900/20 border-red-500/50 text-red-400'}`;
                alertBox.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => alertBox.classList.add('hidden'), 4000);
            };

            // --- Daily Menu Logic ---
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length !== 3) return dateStr;
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            };

            const renderDailyMenu = () => {
                dailyMenuContainer.innerHTML = '';
                
                if (!appData.dailyMenu || appData.dailyMenu.length === 0) {
                    dailyMenuContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Zatím nebyly přidány žádné položky denního menu.</p>';
                    return;
                }

                // Group by date
                const grouped = appData.dailyMenu.reduce((acc, item) => {
                    if (!acc[item.date]) acc[item.date] = [];
                    acc[item.date].push(item);
                    return acc;
                }, {});

                // Sort dates (newest first or upcoming first)
                const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(date => {
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'bg-black border border-white/5 rounded-sm overflow-hidden';
                    
                    const header = document.createElement('div');
                    header.className = 'bg-white/5 border-b border-white/5 px-4 py-2 flex justify-between items-center';
                    
                    const isToday = date === new Date().toISOString().split('T')[0];
                    
                    header.innerHTML = `
                        <h4 class="font-heading tracking-widest text-sm text-brand-gold uppercase">
                            ${formatDate(date)} ${isToday ? '<span class="ml-2 text-[10px] bg-brand-gold text-black px-2 py-0.5 rounded-sm">DNES</span>' : ''}
                        </h4>
                        <button type="button" class="delete-date-btn text-xs text-red-500 hover:text-red-400 transition" data-date="${date}">
                            <i class="fas fa-trash-alt mr-1"></i> Smazat celý den
                        </button>
                    `;
                    dateGroup.appendChild(header);

                    const itemsList = document.createElement('div');
                    itemsList.className = 'p-4 space-y-3';

                    grouped[date].forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between gap-4 text-sm';
                        row.innerHTML = `
                            <div class="flex-grow flex items-center gap-3">
                                <span class="text-gray-400 w-16 text-right font-mono text-xs">${item.amount ? item.amount + item.unit : ''}</span>
                                <span class="text-white">${item.desc}</span>
                            </div>
                            <div class="flex items-center gap-4 shrink-0">
                                <span class="text-brand-gold font-bold">${item.price} Kč</span>
                                <button type="button" class="delete-item-btn text-gray-500 hover:text-red-500 transition" data-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        itemsList.appendChild(row);
                    });

                    dateGroup.appendChild(itemsList);
                    dailyMenuContainer.appendChild(dateGroup);
                });

                // Attach events
                document.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        appData.dailyMenu = appData.dailyMenu.filter(item => item.id !== id);
                        renderDailyMenu();
                    });
                });

                document.querySelectorAll('.delete-date-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const date = e.currentTarget.getAttribute('data-date');
                        if (confirm(`Opravdu chcete smazat celé menu pro den ${formatDate(date)}?`)) {
                            appData.dailyMenu = appData.dailyMenu.filter(item => item.date !== date);
                            renderDailyMenu();
                        }
                    });
                });
            };

            addMenuItemBtn.addEventListener('click', () => {
                const date = menuDateInput.value;
                const amount = menuAmountInput.value.trim();
                const unit = menuUnitInput.value;
                const desc = menuDescInput.value.trim();
                const price = menuPriceInput.value.trim();

                if (!date || !desc || !price) {
                    alert('Vyplňte prosím datum, název jídla a cenu.');
                    return;
                }

                if (!appData.dailyMenu) appData.dailyMenu = [];

                appData.dailyMenu.push({
                    id: Date.now(), // simple unique ID
                    date,
                    amount,
                    unit,
                    desc,
                    price
                });

                menuAmountInput.value = '';
                menuDescInput.value = '';
                menuPriceInput.value = '';
                menuAmountInput.focus();

                renderDailyMenu();
            });

            // Enter klávesa pro přidání jídla
            [menuAmountInput, menuDescInput, menuPriceInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addMenuItemBtn.click();
                    }
                });
            });


            // --- Builder (Oteviraci Doba) Logic ---
            const formatDaysLabel = (dayIds) => {
                const sortedDays = ALL_DAYS.filter(d => dayIds.includes(d.id));
                return sortedDays.map(d => d.name).join(', ');
            };

            const getAvailableDayIds = () => {
                const usedDays = appData.flexibleHours.flatMap(g => g.days);
                return ALL_DAYS.map(d => d.id).filter(id => !usedDays.includes(id));
            };

            const renderGroups = () => {
                groupsContainer.innerHTML = '';
                
                if (appData.flexibleHours.length === 0) {
                    groupsContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Zatím nejsou nastaveny žádné otevírací hodiny. Nevyplněné dny se na webu zobrazí jako ZAVŘENO.</p>';
                }

                appData.flexibleHours.forEach((group, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-black border border-white/10 rounded-sm p-4 flex flex-col sm:flex-row sm:items-center gap-4 group";
                    
                    const label = formatDaysLabel(group.days);
                    
                    div.innerHTML = `
                        <div class="sm:w-1/3">
                            <span class="text-sm text-brand-gold font-bold tracking-wider uppercase">${label}</span>
                        </div>
                        <div class="sm:w-2/3 flex items-center gap-2">
                            <input type="text" value="${group.time}" class="flex-grow bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition group-time-input" data-index="${index}">
                            <button type="button" class="delete-group-btn w-10 h-10 bg-red-900/20 text-red-500 border border-red-500/30 rounded-sm hover:bg-red-500 hover:text-white transition flex items-center justify-center" data-index="${index}" title="Smazat skupinu">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    groupsContainer.appendChild(div);
                });

                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = e.currentTarget.getAttribute('data-index');
                        appData.flexibleHours.splice(idx, 1);
                        renderBuilder();
                    });
                });

                document.querySelectorAll('.group-time-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const idx = e.target.getAttribute('data-index');
                        appData.flexibleHours[idx].time = e.target.value;
                    });
                });
            };

            const renderBuilder = () => {
                renderGroups();
                
                const availableIds = getAvailableDayIds();
                availableDaysContainer.innerHTML = '';
                
                selectedDaysForNewGroup = new Set([...selectedDaysForNewGroup].filter(id => availableIds.includes(id)));

                if (availableIds.length === 0) {
                    availableDaysContainer.innerHTML = '<span class="text-sm text-green-500"><i class="fas fa-check mr-1"></i> Všechny dny v týdnu jsou již přiřazeny.</span>';
                    newGroupTimeSection.classList.add('opacity-50', 'pointer-events-none');
                    newGroupTimeInput.value = '';
                    return;
                }

                ALL_DAYS.forEach(day => {
                    if (availableIds.includes(day.id)) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        const isSelected = selectedDaysForNewGroup.has(day.id);
                        
                        btn.className = `px-3 py-1.5 text-sm font-bold rounded-sm border transition duration-200 ${isSelected ? 'bg-brand-gold text-black border-brand-gold' : 'bg-white/5 text-gray-400 border-white/20 hover:border-white/50 hover:text-white'}`;
                        btn.textContent = day.name;
                        
                        btn.addEventListener('click', () => {
                            if (selectedDaysForNewGroup.has(day.id)) {
                                selectedDaysForNewGroup.delete(day.id);
                            } else {
                                selectedDaysForNewGroup.add(day.id);
                            }
                            renderBuilder();
                        });

                        availableDaysContainer.appendChild(btn);
                    }
                });

                if (selectedDaysForNewGroup.size > 0) {
                    newGroupTimeSection.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    newGroupTimeSection.classList.add('opacity-50', 'pointer-events-none');
                }
            };

            addGroupBtn.addEventListener('click', () => {
                const timeVal = newGroupTimeInput.value.trim();
                if (selectedDaysForNewGroup.size > 0 && timeVal !== '') {
                    const sortedSelectedDays = ALL_DAYS.filter(d => selectedDaysForNewGroup.has(d.id)).map(d => d.id);
                    
                    appData.flexibleHours.push({
                        days: sortedSelectedDays,
                        time: timeVal
                    });
                    
                    appData.flexibleHours.sort((a, b) => {
                        const indexA = ALL_DAYS.findIndex(d => d.id === a.days[0]);
                        const indexB = ALL_DAYS.findIndex(d => d.id === b.days[0]);
                        return indexA - indexB;
                    });

                    selectedDaysForNewGroup.clear();
                    newGroupTimeInput.value = '';
                    renderBuilder();
                }
            });

            // --- Image resize & base64 logic ---\
            promoImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxDim = 1000; // max resolution

                        if (width > height) {
                            if (width > maxDim) {
                                height *= maxDim / width;
                                width = maxDim;
                            }
                        } else {
                            if (height > maxDim) {
                                width *= maxDim / height;
                                height = maxDim;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Zkonvertovat na base64 (s kompresí 80% pro zmenšení velikosti souboru)
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        appData.promoPopup.imageData = base64;
                        promoPreview.src = base64;
                        promoPreviewContainer.classList.remove('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });

            promoRemoveImg.addEventListener('click', () => {
                appData.promoPopup.imageData = '';
                promoPreview.src = '';
                promoPreviewContainer.classList.add('hidden');
                promoImageInput.value = '';
            });

            // --- Fetch initial data ---
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const data = await response.json();
                    appData.contacts = data.contacts || {};
                    appData.delivery = data.delivery || { wolt: '', foodora: '' };
                    appData.promoPopup = data.promoPopup || { active: false, dateFrom: '', dateTo: '', imageData: '' };
                    appData.dailyMenu = data.dailyMenu || [];
                    
                    if (data.flexibleHours) {
                        appData.flexibleHours = data.flexibleHours;
                    }

                    document.getElementById('phoneMain').value = appData.contacts.phoneMain || '';
                    document.getElementById('phoneAlt').value = appData.contacts.phoneAlt || '';
                    document.getElementById('email').value = appData.contacts.email || '';
                    
                    document.getElementById('woltUrl').value = appData.delivery.wolt || '';
                    document.getElementById('foodoraUrl').value = appData.delivery.foodora || '';

                    // Load Promo Popup config
                    promoActive.checked = appData.promoPopup.active;
                    promoDateFrom.value = appData.promoPopup.dateFrom || '';
                    promoDateTo.value = appData.promoPopup.dateTo || '';
                    if (appData.promoPopup.imageData) {
                        promoPreview.src = appData.promoPopup.imageData;
                        promoPreviewContainer.classList.remove('hidden');
                    }

                    renderBuilder();
                    renderDailyMenu();
                }
            } catch (err) {
                showAlert('Chyba při načítání dat ze serveru.', false);
            }

            // --- Save logic ---
            const saveData = async () => {
                appData.contacts.phoneMain = document.getElementById('phoneMain').value;
                appData.contacts.phoneAlt = document.getElementById('phoneAlt').value;
                appData.contacts.email = document.getElementById('email').value;

                appData.delivery.wolt = document.getElementById('woltUrl').value;
                appData.delivery.foodora = document.getElementById('foodoraUrl').value;

                appData.promoPopup.active = promoActive.checked;
                appData.promoPopup.dateFrom = promoDateFrom.value;
                appData.promoPopup.dateTo = promoDateTo.value;

                try {
                    const res = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appData)
                    });
                    
                    if (res.ok) {
                        showAlert('Změny byly úspěšně uloženy a promítnuty na web.', true);
                    } else {
                        showAlert('Nepodařilo se uložit data na server.', false);
                    }
                } catch (err) {
                    showAlert('Kritická chyba při ukládání. Zkontrolujte připojení.', false);
                }
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveData();
            });

            topSaveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                saveData();
            });
        });
    </script>
</body>
</html>