<!DOCTYPE html>
<html lang="cs" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portál | America Pod Věží</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (build) -->
    <link rel="stylesheet" href="output.css">
    <!-- Tailwind CDN jako fallback pro admin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                gold: '#D4A373',
                black: '#0a0a0a'
              }
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              heading: ['Oswald', 'sans-serif']
            }
          }
        }
      }
    </script>
    <link rel="stylesheet" href="fa/css/fontawesome.min.css">
    <link rel="stylesheet" href="fa/css/solid.min.css">
</head>
<body class="bg-[#0a0a0a] text-white min-h-screen flex flex-col font-sans">
    
    <!-- Header -->
    <header class="bg-black border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-white font-heading font-bold tracking-[0.2em] text-lg border border-brand-gold/50 px-3 py-1 bg-brand-gold/10 shadow-[0_0_10px_rgba(212,163,115,0.2)]">
                    ADMIN
                </span>
                <span class="hidden md:inline text-brand-gold font-heading tracking-widest text-sm uppercase opacity-80">
                    America Pod Věží
                </span>
            </div>
            <div class="flex items-center gap-4">
                <a href="/" target="_blank" class="text-xs text-gray-400 hover:text-white uppercase tracking-widest transition flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i> Web
                </a>
                <button id="save-btn-top" class="bg-brand-gold text-black font-heading font-bold uppercase tracking-widest text-xs px-4 py-2 rounded-sm hover:bg-white transition">
                    Uložit
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-6 py-10">
        
        <div id="alert" class="hidden mb-8 p-4 rounded-sm text-sm font-bold border flex items-center gap-3">
            <i class="fas" id="alert-icon"></i>
            <span id="alert-text"></span>
        </div>

        <form id="admin-form" class="space-y-10">
            
            <!-- Sekce: Flexibilní Otevírací doba -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Otevírací doba</h2>
                </div>

                <p class="text-gray-400 text-sm mb-6 font-light leading-relaxed">
                    Zde můžete libovolně slučovat dny, které mají stejnou otevírací dobu. 
                    Kliknutím na dny je vyberete do jedné skupiny. Jakmile skupinu vytvoříte, můžete k ní napsat čas.
                    <strong class="text-brand-gold block mt-2">Nevyplněné dny se na webu automaticky zobrazí jako ZAVŘENO.</strong>
                </p>

                <!-- Builder Container -->
                <div class="space-y-6">
                    
                    <!-- Existující skupiny -->
                    <div id="hours-groups-container" class="space-y-4">
                        <!-- Zde se vykreslí aktuální skupiny z JS -->
                    </div>

                    <!-- Přidání nové skupiny -->
                    <div id="new-group-builder" class="bg-black border border-brand-gold/30 rounded-sm p-5 shadow-[0_0_15px_rgba(212,163,115,0.1)]">
                        <h3 class="font-heading uppercase tracking-widest text-xs text-brand-gold mb-4">Vytvořit novou skupinu dnů:</h3>
                        
                        <div class="flex flex-wrap gap-2 mb-4" id="available-days">
                            <!-- Tlačítka pro volné dny vygeneruje JS -->
                        </div>

                        <div class="flex gap-3 items-center opacity-50 pointer-events-none transition-opacity duration-300" id="new-group-time-section">
                            <input type="text" id="new-group-time" placeholder="např. 11:00 - 22:00 nebo ZAVŘENO" class="flex-grow bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 placeholder-gray-600">
                            <button type="button" id="add-group-btn" class="bg-white/10 hover:bg-brand-gold text-white hover:text-black border border-white/20 hover:border-brand-gold px-4 py-2 rounded-sm transition duration-300 text-sm font-bold tracking-wider uppercase whitespace-nowrap">
                                <i class="fas fa-plus mr-1"></i> Přidat
                            </button>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Sekce: Kontakty -->
            <section class="bg-[#111] border border-white/10 rounded-sm p-6 md:p-8 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="w-8 h-8 rounded-full border border-brand-gold/30 bg-brand-gold/10 flex items-center justify-center text-brand-gold">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <h2 class="text-2xl font-heading font-bold tracking-widest uppercase text-white">Kontaktní údaje</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Hlavní telefon</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-phone text-gray-500 text-sm"></i>
                            </div>
                            <input type="text" id="phoneMain" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">Alternativní telefon</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-mobile-alt text-gray-500 text-sm pl-0.5"></i>
                            </div>
                            <input type="text" id="phoneAlt" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-heading tracking-widest uppercase text-gray-400 mb-2">E-mailová adresa</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-envelope text-gray-500 text-sm"></i>
                            </div>
                            <input type="email" id="email" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-sm py-2 pl-10 pr-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition shadow-inner">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ulozit Dole -->
            <div class="flex justify-end pt-4">
                <button type="submit" class="bg-brand-gold text-black font-heading font-bold uppercase tracking-widest py-3 px-10 rounded-sm hover:bg-white transition shadow-[0_0_15px_rgba(212,163,115,0.4)] hover:shadow-[0_0_20px_rgba(255,255,255,0.5)] transform hover:-translate-y-1">
                    Uložit změny
                </button>
            </div>
        </form>
    </main>

    <!-- Patička -->
    <footer class="bg-black text-center py-6 border-t border-white/10 mt-auto">
        <p class="text-[10px] uppercase tracking-widest text-gray-600">
            America Pod Věží &copy; <span id="year"></span> | Admin Modul
        </p>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('admin-form');
            const alertBox = document.getElementById('alert');
            const alertIcon = document.getElementById('alert-icon');
            const alertText = document.getElementById('alert-text');
            const topSaveBtn = document.getElementById('save-btn-top');

            // Builder elements
            const groupsContainer = document.getElementById('hours-groups-container');
            const availableDaysContainer = document.getElementById('available-days');
            const newGroupTimeSection = document.getElementById('new-group-time-section');
            const newGroupTimeInput = document.getElementById('new-group-time');
            const addGroupBtn = document.getElementById('add-group-btn');
            
            const ALL_DAYS = [
                { id: 'mo', name: 'Pondělí' },
                { id: 'tu', name: 'Úterý' },
                { id: 'we', name: 'Středa' },
                { id: 'th', name: 'Čtvrtek' },
                { id: 'fr', name: 'Pátek' },
                { id: 'sa', name: 'Sobota' },
                { id: 'su', name: 'Neděle' }
            ];

            let appData = {
                flexibleHours: [],
                contacts: {}
            };

            let selectedDaysForNewGroup = new Set();

            const showAlert = (msg, isSuccess) => {
                alertText.textContent = msg;
                alertIcon.className = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
                alertBox.className = `mb-8 p-4 rounded-sm text-sm font-bold border flex items-center gap-3 ${isSuccess ? 'bg-green-900/20 border-green-500/50 text-green-400' : 'bg-red-900/20 border-red-500/50 text-red-400'}`;
                alertBox.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => alertBox.classList.add('hidden'), 4000);
            };

            const formatDaysLabel = (dayIds) => {
                const sortedDays = ALL_DAYS.filter(d => dayIds.includes(d.id));
                return sortedDays.map(d => d.name).join(', ');
            };

            const getAvailableDayIds = () => {
                const usedDays = appData.flexibleHours.flatMap(g => g.days);
                return ALL_DAYS.map(d => d.id).filter(id => !usedDays.includes(id));
            };

            const renderGroups = () => {
                groupsContainer.innerHTML = '';
                
                if (appData.flexibleHours.length === 0) {
                    groupsContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Zatím nejsou nastaveny žádné otevírací hodiny. Nevyplněné dny se na webu zobrazí jako ZAVŘENO.</p>';
                }

                appData.flexibleHours.forEach((group, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-black border border-white/10 rounded-sm p-4 flex flex-col sm:flex-row sm:items-center gap-4 group";
                    
                    const label = formatDaysLabel(group.days);
                    
                    div.innerHTML = `
                        <div class="sm:w-1/3">
                            <span class="text-sm text-brand-gold font-bold tracking-wider uppercase">${label}</span>
                        </div>
                        <div class="sm:w-2/3 flex items-center gap-2">
                            <input type="text" value="${group.time}" class="flex-grow bg-[#1a1a1a] border border-white/20 text-white text-sm rounded-sm py-2 px-3 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 transition group-time-input" data-index="${index}">
                            <button type="button" class="delete-group-btn w-10 h-10 bg-red-900/20 text-red-500 border border-red-500/30 rounded-sm hover:bg-red-500 hover:text-white transition flex items-center justify-center" data-index="${index}" title="Smazat skupinu">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    groupsContainer.appendChild(div);
                });

                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = e.currentTarget.getAttribute('data-index');
                        appData.flexibleHours.splice(idx, 1);
                        renderBuilder();
                    });
                });

                document.querySelectorAll('.group-time-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const idx = e.target.getAttribute('data-index');
                        appData.flexibleHours[idx].time = e.target.value;
                    });
                });
            };

            const renderBuilder = () => {
                renderGroups();
                
                const availableIds = getAvailableDayIds();
                availableDaysContainer.innerHTML = '';
                
                selectedDaysForNewGroup = new Set([...selectedDaysForNewGroup].filter(id => availableIds.includes(id)));

                if (availableIds.length === 0) {
                    availableDaysContainer.innerHTML = '<span class="text-sm text-green-500"><i class="fas fa-check mr-1"></i> Všechny dny v týdnu jsou již přiřazeny.</span>';
                    newGroupTimeSection.classList.add('opacity-50', 'pointer-events-none');
                    newGroupTimeInput.value = '';
                    return;
                }

                ALL_DAYS.forEach(day => {
                    if (availableIds.includes(day.id)) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        const isSelected = selectedDaysForNewGroup.has(day.id);
                        
                        btn.className = `px-3 py-1.5 text-sm font-bold rounded-sm border transition duration-200 ${isSelected ? 'bg-brand-gold text-black border-brand-gold' : 'bg-white/5 text-gray-400 border-white/20 hover:border-white/50 hover:text-white'}`;
                        btn.textContent = day.name;
                        
                        btn.addEventListener('click', () => {
                            if (selectedDaysForNewGroup.has(day.id)) {
                                selectedDaysForNewGroup.delete(day.id);
                            } else {
                                selectedDaysForNewGroup.add(day.id);
                            }
                            renderBuilder();
                        });

                        availableDaysContainer.appendChild(btn);
                    }
                });

                if (selectedDaysForNewGroup.size > 0) {
                    newGroupTimeSection.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    newGroupTimeSection.classList.add('opacity-50', 'pointer-events-none');
                }
            };

            addGroupBtn.addEventListener('click', () => {
                const timeVal = newGroupTimeInput.value.trim();
                if (selectedDaysForNewGroup.size > 0 && timeVal !== '') {
                    const sortedSelectedDays = ALL_DAYS.filter(d => selectedDaysForNewGroup.has(d.id)).map(d => d.id);
                    
                    appData.flexibleHours.push({
                        days: sortedSelectedDays,
                        time: timeVal
                    });
                    
                    appData.flexibleHours.sort((a, b) => {
                        const indexA = ALL_DAYS.findIndex(d => d.id === a.days[0]);
                        const indexB = ALL_DAYS.findIndex(d => d.id === b.days[0]);
                        return indexA - indexB;
                    });

                    selectedDaysForNewGroup.clear();
                    newGroupTimeInput.value = '';
                    renderBuilder();
                }
            });

            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const data = await response.json();
                    appData.contacts = data.contacts || {};
                    
                    if (data.flexibleHours) {
                        appData.flexibleHours = data.flexibleHours;
                    }

                    document.getElementById('phoneMain').value = appData.contacts.phoneMain || '';
                    document.getElementById('phoneAlt').value = appData.contacts.phoneAlt || '';
                    document.getElementById('email').value = appData.contacts.email || '';

                    renderBuilder();
                }
            } catch (err) {
                showAlert('Chyba při načítání dat ze serveru.', false);
            }

            const saveData = async () => {
                // ODSTRANĚNA VALIDACE VŠECH DNŮ - backend/frontend se s tím vypořádá tak, že zbytek bude ZAVŘENO

                appData.contacts.phoneMain = document.getElementById('phoneMain').value;
                appData.contacts.phoneAlt = document.getElementById('phoneAlt').value;
                appData.contacts.email = document.getElementById('email').value;

                try {
                    const res = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appData)
                    });
                    
                    if (res.ok) {
                        showAlert('Změny byly úspěšně uloženy a promítnuty na web.', true);
                    } else {
                        showAlert('Nepodařilo se uložit data na server.', false);
                    }
                } catch (err) {
                    showAlert('Kritická chyba při ukládání. Zkontrolujte připojení.', false);
                }
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveData();
            });

            topSaveBtn.addEventListener('click', (e) => {
                e.preventDefault();
                saveData();
            });

            newGroupTimeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addGroupBtn.click();
                }
            });
        });
    </script>
</body>
</html>